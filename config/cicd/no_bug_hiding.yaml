# No Bug-Hiding Enforcement Configuration
#
# This file configures the no_bug_hiding static analysis tool.
# It detects defensive programming patterns that hide bugs instead of fixing them.
#
# Philosophy:
#   - Inside the tent: fail fast, no patterns that mask bugs
#   - At boundaries: explicit validation allowed, but must be intentional and documented
#
# Key format: <file_path>:<rule_id>:<symbol_context>:line=<lineno>
#
# Rules:
#   R1: dict.get() usage - hides missing key bugs
#   R2: getattr() with default - hides missing attribute bugs
#   R3: hasattr() usage - branches around missing attributes
#   R4: broad exception handling without re-raise - suppresses bugs

version: 1

defaults:
  # Fail CI if an allowlist entry doesn't match any code (stale entry)
  fail_on_stale: true
  # Fail CI if an allowlist entry has expired
  fail_on_expired: true

allow_hits:

  # ============================================================
  # TUI TRUST BOUNDARY (Permanent)
  # ============================================================
  # These display Landscape data that may be incomplete for failed/partial
  # runs. Graceful degradation to default values is appropriate - users see
  # partial data rather than a crash. This is intentional UX design.
  # ============================================================

  # --- ExplainScreen exception handling ---
  - key: "tui/screens/explain_screen.py:R4:ExplainScreen:_load_pipeline_structure:line=167"
    owner: "architecture"
    reason: "Trust boundary: loading pipeline structure that may fail for corrupt/incomplete runs"
    safety: "Graceful degradation - returns LoadingFailedState instead of crash"
    expires: null  # Permanent - intentional design

  - key: "tui/screens/explain_screen.py:R4:ExplainScreen:_load_node_state:line=251"
    owner: "architecture"
    reason: "Trust boundary: loading node state that may fail for incomplete audit trails"
    safety: "Graceful degradation - returns None to detail panel instead of crash"
    expires: null  # Permanent - intentional design

  # --- LineageTree ---
  # LineageTree now uses strict LineageData TypedDict contract (Task 10).
  # No allowlist entries needed - callers must provide valid data.

  # --- NodeDetailPanel displaying node state ---
  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=42"
    owner: "architecture"
    reason: "Trust boundary: displaying node plugin_name that may be missing"
    safety: "Graceful degradation to 'unknown' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=43"
    owner: "architecture"
    reason: "Trust boundary: displaying node_type that may be missing"
    safety: "Graceful degradation to 'unknown' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=49"
    owner: "architecture"
    reason: "Trust boundary: displaying state_id that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=50"
    owner: "architecture"
    reason: "Trust boundary: displaying node_id that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=51"
    owner: "architecture"
    reason: "Trust boundary: displaying token_id that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=55"
    owner: "architecture"
    reason: "Trust boundary: displaying status that may be missing"
    safety: "Graceful degradation to 'unknown' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=58"
    owner: "architecture"
    reason: "Trust boundary: displaying started_at that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=59"
    owner: "architecture"
    reason: "Trust boundary: displaying completed_at that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial data"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=60"
    owner: "architecture"
    reason: "Trust boundary: displaying duration_ms that may be missing"
    safety: "Graceful degradation to None - conditionally displayed"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=67"
    owner: "architecture"
    reason: "Trust boundary: displaying input_hash that may be missing"
    safety: "Graceful degradation to None - conditionally displayed"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=68"
    owner: "architecture"
    reason: "Trust boundary: displaying output_hash that may be missing"
    safety: "Graceful degradation to None - conditionally displayed"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=75"
    owner: "architecture"
    reason: "Trust boundary: displaying error_json that may be missing"
    safety: "Graceful degradation to None - error section conditionally shown"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=85"
    owner: "architecture"
    reason: "Trust boundary: displaying error type from JSON that may be malformed"
    safety: "Graceful degradation to 'unknown' - user sees partial error info"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=86"
    owner: "architecture"
    reason: "Trust boundary: displaying error message from JSON that may be malformed"
    safety: "Graceful degradation to 'unknown' - user sees partial error info"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=95"
    owner: "architecture"
    reason: "Trust boundary: state_id lookup for logging context"
    safety: "None is safe - just means unknown state_id in log message"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=106"
    owner: "architecture"
    reason: "Trust boundary: displaying artifact that may be missing"
    safety: "Graceful degradation to None - artifact section conditionally shown"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=110"
    owner: "architecture"
    reason: "Trust boundary: displaying artifact_id that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial artifact info"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=111"
    owner: "architecture"
    reason: "Trust boundary: displaying path_or_uri that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial artifact info"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=112"
    owner: "architecture"
    reason: "Trust boundary: displaying content_hash that may be missing"
    safety: "Graceful degradation to 'N/A' - user sees partial artifact info"
    expires: null  # Permanent - intentional design

  - key: "tui/widgets/node_detail.py:R1:NodeDetailPanel:render_content:line=113"
    owner: "architecture"
    reason: "Trust boundary: displaying size_bytes that may be missing"
    safety: "Graceful degradation to None - conditionally displayed"
    expires: null  # Permanent - intentional design

  # ============================================================
  # PLUGIN MANAGER OPTIONAL API (Permanent)
  # ============================================================
  # These methods return Optional[T] by design - the documented API contract
  # is that callers check the return value. Returning None for unknown plugin
  # names is intentional, not a bug-hiding pattern.
  # ============================================================

  - key: "plugins/manager.py:R1:PluginManager:get_source_by_name:line=293"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R1:PluginManager:get_transform_by_name:line=297"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R1:PluginManager:get_gate_by_name:line=301"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R1:PluginManager:get_aggregation_by_name:line=305"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R1:PluginManager:get_coalesce_by_name:line=309"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R1:PluginManager:get_sink_by_name:line=313"
    owner: "architecture"
    reason: "Intentional Optional API: returns None for unknown plugin names"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  # ============================================================
  # TRANSFORM/GATE CLEANUP (Permanent)
  # ============================================================
  # The orchestrator calls close() on transforms/gates in a finally block.
  # Old plugins may not have close() method, so hasattr check is required.
  # Cleanup should be best-effort - one plugin failure shouldn't crash the
  # whole cleanup process.
  # ============================================================

  - key: "engine/orchestrator.py:R3:Orchestrator:_cleanup_transforms:line=168"
    owner: "architecture"
    reason: "Trust boundary: old plugins may not implement close() method"
    safety: "Duck-typing at plugin boundary - graceful skip for legacy plugins"
    expires: null  # Permanent - intentional design

  - key: "engine/orchestrator.py:R4:Orchestrator:_cleanup_transforms:line=170"
    owner: "architecture"
    reason: "Best-effort cleanup: one plugin failure shouldn't prevent others from cleanup"
    safety: "Logged with warning, other plugins still get close() called"
    expires: null  # Permanent - intentional design

  - key: "engine/orchestrator.py:R2:Orchestrator:_cleanup_transforms:line=174"
    owner: "architecture"
    reason: "Trust boundary: plugin may not have name attribute"
    safety: "Fallback to str() for log message - never raises"
    expires: null  # Permanent - intentional design

  # ============================================================
  # ROUTE VALIDATION (Permanent)
  # ============================================================
  # Route validation builds a lookup from node_id to gate name for error
  # messages. These lookups are for UI/diagnostic purposes only.
  # ============================================================

  - key: "engine/orchestrator.py:R1:Orchestrator:_validate_route_destinations:line=203"
    owner: "architecture"
    reason: "Building lookup for gate names - only gates (not transforms) are in map"
    safety: "None means 'not a gate at this sequence' - correctly skipped"
    expires: null  # Permanent - intentional design

  - key: "engine/orchestrator.py:R1:Orchestrator:_validate_route_destinations:line=215"
    owner: "architecture"
    reason: "Fallback for error message - use node_id if gate name not found"
    safety: "Error message still produced with node_id as fallback"
    expires: null  # Permanent - intentional design

  # ============================================================
  # PLUGIN METADATA EXTRACTION (Permanent)
  # ============================================================
  # The orchestrator extracts optional plugin metadata (version, determinism)
  # using getattr because plugins may not define these attributes. This is
  # legitimate duck-typing at a plugin trust boundary.
  # ============================================================

  - key: "engine/orchestrator.py:R2:Orchestrator:_execute_run:line=414"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define plugin_version attribute"
    safety: "Duck-typing at plugin boundary - fallback to '0.0.0' is documented behavior"
    expires: null  # Permanent - intentional design

  - key: "engine/orchestrator.py:R2:Orchestrator:_execute_run:line=419"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define determinism attribute"
    safety: "Duck-typing at plugin boundary - fallback to DETERMINISTIC is documented"
    expires: null  # Permanent - intentional design

  # ============================================================
  # ENVIRONMENT VARIABLE LOOKUP (Permanent)
  # ============================================================
  # os.environ.get() is the standard Python pattern for optional environment
  # variables. This is explicitly checked and raises if missing when required.
  # ============================================================

  - key: "engine/orchestrator.py:R1:Orchestrator:_export_landscape:line=654"
    owner: "architecture"
    reason: "Standard pattern: optional environment variable with explicit check"
    safety: "Raises ValueError with clear message if signing enabled but key missing"
    expires: null  # Permanent - intentional design

  # ============================================================
  # TRANSFORM ERROR ROUTING (Permanent)
  # ============================================================
  # TransformExecutor checks for optional _on_error attribute to route
  # TransformResult.error() rows. RuntimeError if error without on_error.
  # ============================================================

  - key: "engine/executors.py:R2:TransformExecutor:execute_transform:line=212"
    owner: "architecture"
    reason: "Trust boundary: transforms optionally define _on_error attribute"
    safety: "Raises RuntimeError if transform errors without on_error config"
    expires: null  # Permanent - intentional design

  # ============================================================
  # GATE ROUTING LOOKUPS (Permanent)
  # ============================================================
  # Gate executors look up routing destinations and edge IDs. Missing
  # entries raise MissingEdgeError with clear diagnostics.
  # ============================================================

  - key: "engine/executors.py:R1:GateExecutor:execute_gate:line=363"
    owner: "architecture"
    reason: "Lookup with explicit None check - raises MissingEdgeError if not found"
    safety: "Raises immediately with node_id and label for debugging"
    expires: null  # Permanent - intentional design

  - key: "engine/executors.py:R1:GateExecutor:_record_routing:line=439"
    owner: "architecture"
    reason: "Lookup with explicit None check - raises MissingEdgeError if not found"
    safety: "Raises immediately with node_id and label for debugging"
    expires: null  # Permanent - intentional design

  - key: "engine/executors.py:R1:GateExecutor:_record_routing:line=453"
    owner: "architecture"
    reason: "Lookup with explicit None check - raises MissingEdgeError if not found"
    safety: "Raises immediately with node_id and label for debugging"
    expires: null  # Permanent - intentional design

  # ============================================================
  # AGGREGATION BATCH STATE LOOKUPS (Permanent)
  # ============================================================
  # AggregationExecutor tracks batch IDs internally in _batch_ids dict.
  # These lookups check if a batch exists for a node_id. Missing entries
  # are valid (no batch yet) or raise ValueError with clear diagnostics.
  # ============================================================

  - key: "engine/executors.py:R1:AggregationExecutor:get_batch_id:line=510"
    owner: "architecture"
    reason: "Intentional Optional API: returns None if no batch exists for node_id"
    safety: "Callers check return value - this is the documented contract"
    expires: null  # Permanent - intentional design

  - key: "engine/executors.py:R1:AggregationExecutor:accept:line=540"
    owner: "architecture"
    reason: "Checking if batch exists to decide whether to create one"
    safety: "None means 'create new batch' - explicit conditional logic follows"
    expires: null  # Permanent - intentional design

  - key: "engine/executors.py:R1:AggregationExecutor:flush:line=642"
    owner: "architecture"
    reason: "Lookup with explicit None check - raises ValueError if no batch to flush"
    safety: "Raises immediately with node_id for debugging"
    expires: null  # Permanent - intentional design

  # ============================================================
  # PLUGIN METADATA EXTRACTION - MANAGER (Permanent)
  # ============================================================
  # These patterns extract optional attributes from plugins using getattr/hasattr.
  # Plugins may not define these optional attributes. This is legitimate duck-typing
  # at a plugin trust boundary. Required attributes (name, plugin_version) now
  # fail loudly if missing (Task 9).
  # ============================================================

  - key: "plugins/manager.py:R3:_schema_hash:line=46"
    owner: "architecture"
    reason: "Trust boundary: checking if plugin class has Pydantic model_fields"
    safety: "Graceful fallback to None - non-Pydantic plugins don't have schema hashes"
    expires: null  # Permanent - intentional design

  # PluginSpec.from_plugin - OPTIONAL attributes only (name/version now required)
  - key: "plugins/manager.py:R2:PluginSpec:from_plugin:line=113"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define determinism attribute"
    safety: "Duck-typing at plugin boundary - fallback to DETERMINISTIC is documented default"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginSpec:from_plugin:line=116"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define input_schema attribute"
    safety: "Duck-typing at plugin boundary - fallback to None (any schema accepted)"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginSpec:from_plugin:line=117"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define output_schema attribute"
    safety: "Duck-typing at plugin boundary - fallback to None (any schema accepted)"
    expires: null  # Permanent - intentional design

  # PluginManager._refresh_caches - uses getattr for name fallback to __name__
  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=197"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=207"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=217"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=227"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=237"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  - key: "plugins/manager.py:R2:PluginManager:_refresh_caches:line=247"
    owner: "architecture"
    reason: "Trust boundary: plugins may not define name attribute"
    safety: "Duck-typing at plugin boundary - fallback to __name__ is documented"
    expires: null  # Permanent - intentional design

  # ============================================================
  # SCHEMA VALIDATION TRUST BOUNDARY (Permanent)
  # ============================================================
  # These patterns handle Pydantic validation errors and type introspection.
  # Pydantic errors are external data, type introspection is for error messages.
  # ============================================================

  - key: "contracts/data.py:R1:validate_row:line=101"
    owner: "architecture"
    reason: "Trust boundary: Pydantic error dict may not have 'input' key"
    safety: "Graceful handling - validation error message still produced"
    expires: null  # Permanent - intentional design

  - key: "contracts/data.py:R3:_type_name:line=194"
    owner: "architecture"
    reason: "Type introspection: not all types have __name__ attribute"
    safety: "Graceful fallback to str() - error message still produced"
    expires: null  # Permanent - intentional design

  # ============================================================
  # FIELD MATCH GATE LOOKUP (Permanent)
  # ============================================================
  # The _find_matching_label method returns Optional[str] by design.
  # When looking up user-provided values in the matches dict, returning
  # None is the correct response for "no match found". This is not
  # bug-hiding but legitimate Optional return type semantics.
  # ============================================================

  - key: "plugins/gates/field_match_gate.py:R1:FieldMatchGate:_find_matching_label:line=169"
    owner: "architecture"
    reason: "Intentional Optional API: returns None when value not in matches dict"
    safety: "Caller checks return value - None triggers default_label path"
    expires: null  # Permanent - intentional design

  # ============================================================
  # RETRY CONFIG PARSING (Permanent)
  # ============================================================
  # RetryConfig.from_policy parses external configuration dicts.
  # This is a documented trust boundary where external config may have
  # invalid or missing values.
  # ============================================================

  - key: "engine/retry.py:R1:RetryConfig:from_policy:line=70"
    owner: "architecture"
    reason: "Trust boundary: external policy dict may have invalid/missing values"
    safety: "max() ensures minimum valid value, docstring documents this behavior"
    expires: null  # Permanent - intentional design

  - key: "engine/retry.py:R1:RetryConfig:from_policy:line=71"
    owner: "architecture"
    reason: "Trust boundary: external policy dict may have invalid/missing values"
    safety: "max() ensures minimum valid value, docstring documents this behavior"
    expires: null  # Permanent - intentional design

  - key: "engine/retry.py:R1:RetryConfig:from_policy:line=72"
    owner: "architecture"
    reason: "Trust boundary: external policy dict may have invalid/missing values"
    safety: "max() ensures minimum valid value, docstring documents this behavior"
    expires: null  # Permanent - intentional design

  - key: "engine/retry.py:R1:RetryConfig:from_policy:line=73"
    owner: "architecture"
    reason: "Trust boundary: external policy dict may have invalid/missing values"
    safety: "max() ensures minimum valid value, docstring documents this behavior"
    expires: null  # Permanent - intentional design

  # ============================================================
  # ROW PROCESSOR PLUGIN DISPATCH
  # ============================================================
  # Previously used hasattr duck-typing. Now uses isinstance() checks
  # against base classes (BaseTransform, BaseGate, BaseAggregation).
  # Stale allowlist entries removed by Task 7.
  # ============================================================
