# Example: Pipeline with audit export to JSON
#
# This demonstrates ELSPETH's audit trail export feature for compliance
# and legal inquiry. After a run completes, the full audit trail is
# exported to a JSON sink for review.
#
# Note: Uses JSON format because audit records are heterogeneous (run, node,
# row, token records have different fields). For CSV export, separate files
# per record type would be needed.
#
# Run with:
#   uv run elspeth run -s examples/audit_export/settings.yaml --execute
#
# For signed exports (legal/compliance use):
#   export ELSPETH_SIGNING_KEY="your-secret-key"
#   # Then update sign: true below
#   uv run elspeth run -s examples/audit_export/settings.yaml --execute

datasource:
  plugin: csv
  options:
    path: examples/audit_export/input.csv

row_plugins:
  # Gate: Route corporate submissions to a dedicated sink.
  - plugin: field_match_gate
    type: gate
    options:
      field: category
      matches:
        "corporate": corporate_label
      default_label: non_corporate_label
    routes:
      corporate_label: corporate
      non_corporate_label: continue

sinks:
  non_corporate:
    plugin: csv
    options:
      path: examples/audit_export/output/non_corporate.csv

  corporate:
    plugin: csv
    options:
      path: examples/audit_export/output/corporate.csv

  # Export sink for compliance audit trail (uses JSON for heterogeneous records)
  audit_export:
    plugin: json
    options:
      path: examples/audit_export/output/audit_trail.json

output_sink: non_corporate

# Audit trail configuration
landscape:
  url: sqlite:///examples/audit_export/runs/audit.db
  export:
    enabled: true
    sink: audit_export
    format: json  # Use JSON - audit records have varying schemas per record_type
    sign: false   # Set to true and provide ELSPETH_SIGNING_KEY for legal use
